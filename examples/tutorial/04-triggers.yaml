# This is the same workflow as 03-loops.yaml
# Triggers are configured separately via: conductor triggers add schedule
#
# Example:
#   conductor triggers add schedule meal-plan \
#     --workflow examples/tutorial/04-triggers.yaml \
#     --cron "0 9 * * 0" \
#     --input days=7

name: refined-meal-plan
description: Generate and refine a meal plan until quality standards are met

inputs:
  - name: days
    type: string
    required: false
    default: "3"
    description: Number of days to plan

steps:
  - id: draft
    type: llm
    model: balanced
    prompt: |
      Create a {{.days}}-day meal plan with breakfast, lunch, and dinner for each day.

      Requirements:
      - Variety in proteins, cuisines, and cooking methods
      - Reasonable prep times for weeknight cooking
      - Some ingredient overlap to reduce waste

      Format as a simple list by day.

  - id: refine
    type: loop
    max_iterations: 3
    until: 'steps.critique.response contains "APPROVED"'
    steps:
      - id: critique
        type: llm
        model: balanced
        prompt: |
          Review this meal plan (iteration {{.loop.iteration}}):

          {{.steps.draft.response}}

          Evaluate against these criteria:
          1. Nutritional balance
          2. Practical prep times
          3. Ingredient efficiency
          4. Variety and appeal

          If the plan meets all criteria, respond with exactly: APPROVED
          Otherwise, provide specific improvements needed.

      - id: improve
        type: llm
        model: balanced
        when: 'not (steps.critique.response contains "APPROVED")'
        prompt: |
          Improve this meal plan based on the feedback:

          CURRENT PLAN:
          {{.steps.draft.response}}

          FEEDBACK:
          {{.steps.critique.response}}

          Create an improved version.

outputs:
  - name: meal_plan
    type: string
    value: "{{.steps.refine.improve.response}}"
