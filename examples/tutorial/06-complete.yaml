name: complete-meal-planner
description: Full meal planner with parallel generation and optional webhook delivery

inputs:
  - name: days
    type: string
    required: false
    default: "7"
    description: Number of days to plan
  - name: pantry_file
    type: string
    required: false
    default: "pantry.txt"
    description: Path to pantry inventory
  - name: webhook_url
    type: string
    required: false
    description: Webhook URL for delivery (optional)

steps:
  # Read pantry
  - id: read_pantry
    file.read: "{{.pantry_file}}"

  # Generate meals in parallel
  - id: meals
    type: parallel
    steps:
      - id: weekday
        type: llm
        model: balanced
        prompt: |
          Create weekday meals (Monday-Friday) using these pantry items:
          {{.steps.read_pantry.response}}

          Focus on quick, practical meals for busy days.
          Include breakfast, lunch, dinner for each day.

      - id: weekend
        type: llm
        model: balanced
        prompt: |
          Create weekend meals (Saturday-Sunday) using these pantry items:
          {{.steps.read_pantry.response}}

          Weekend meals can be more elaborate with longer prep times.
          Include breakfast, lunch, dinner for each day.

  # Combine and format
  - id: format
    type: llm
    model: balanced
    prompt: |
      Combine these into one cohesive {{.days}}-day meal plan:

      WEEKDAY MEALS:
      {{.steps.meals.weekday.response}}

      WEEKEND MEALS:
      {{.steps.meals.weekend.response}}

      Format as:
      1. Day-by-day meal plan
      2. Consolidated shopping list (only items not in pantry)
      3. Meal prep tips for the week

  # Refine for quality
  - id: refine
    type: loop
    max_iterations: 2
    until: 'steps.critique.response contains "APPROVED"'
    steps:
      - id: critique
        type: llm
        model: fast
        prompt: |
          Quick review of this meal plan:
          {{.steps.format.response}}

          Is it practical and well-organized? Reply APPROVED if yes.

      - id: improve
        type: llm
        model: balanced
        when: 'not (steps.critique.response contains "APPROVED")'
        prompt: |
          Improve: {{.steps.critique.response}}

          Current plan:
          {{.steps.format.response}}

  # Always save locally
  - id: save_local
    file.write:
      path: meal-plan.md
      content: |
        # Weekly Meal Plan

        {{.steps.refine.improve.response}}

  # Deliver via webhook (if configured)
  - id: deliver
    when: 'webhook_url != ""'
    http.request:
      method: POST
      url: "{{.webhook_url}}"
      headers:
        Content-Type: application/json
      body: '{"text": "Weekly Meal Plan Ready!"}'

outputs:
  - name: meal_plan
    type: string
    value: "{{.steps.refine.improve.response}}"
